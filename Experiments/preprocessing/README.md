The script `preprocess.py` can be used to process a loom file (generated by the MissionBio pipeline) into the input expected by COMPASS.
Note: This script atttemps to select the interesting variants (somatic SNVs or germline SNPs affected by LOH), but it is not perfect. The loom files generated by the Tapestri pipeline sometimes contain false variants, which are not found in bulk data but which are found in a significant proportion of the cells in the loom file. The performance of COMPASS can be strongly impacted by such variants if they are included in the input. Therefore, we recommend removing variants which look unreliable before running COMPASS, by deleting the corresponding rows in the _variants.csv file. Alternatively, we also provide a script `preprocess_robust.py` which is more stringent when selecting the variants, and should avoid the problematic false variants, although some true variants might be missed. Ideally, if you have bulk data and know which variants should be included, you should generate generate COMPASS' input files using the whitelist argument (see below). 

## Dependencies
The dependencies required to run the script can be installed by running:

`pip install numpy pandas loompy varcode`

`pyensembl install --release 75 76`

## Usage

`python preprocess.py -i [input] -o [output_dir]`

The input can either be a single loom file, or a directory containing several loom files.
Optional arguments:

| Argument      | Description |
| ----------- | ----------- |
| --whitelist   | Path to csv file containing the mutations to include (see `mutations.csv` as an example). The sample IDs in column "sample ID" have to match the names of the loom files (i.e. the loom file has to be called sample.loom if the sample ID is "sample").        |
| --SNP     | Path to a tsv file containing the population frequency of variants (see below)       |
| --region   | Region to use for inferring CNVs; must be either 'gene', 'amplicon', 'chromosome' or 'chromosome_arm' (default: gene).       |
| --centromere   | Path to a file containing the position of centromeres, only required if --region is 'chromosome_arm'. centromeres_GRCh37.txt or centromeres_GRCh38.txt can be used.       |
| --panel   | Path to a csv file describing the amplicons. This is sometimes useful to get the correct name of the amplicons.  |
| --ref   | The reference genome (default: 37). Can be 37 for GRCh37 or 38 for GRCh38.  |

## Whitelist

In case, you already know which mutations to include in the analysis, the list of mutations can be passed as the whitelist argument (see `mutations.csv` as an example). Otherwise, the script will attempt to select somatic variants present in some cells but not others, as well as germline variants that might be affected by LOH.

## Population Frequency

Optionally, the preprocessing script can take as input a tsv file containing the population frequency of variants. This is used in the preprocessing to remove germline variants (unless they appear to be affected by LOH in some cells) and, in COMPASS, to penalize variants with a high population frequency which are not placed at the root (since they are likely to be germline variants).
The file that we used was generated using the script `download_1000G.sh`, which was adapted from [this script](https://github.com/single-cell-genetics/cellSNP/blob/master/SNPlist_1Kgenome.sh). You can download it from https://drive.google.com/file/d/14Mm4-ynmaqxFuDFOTTr6PLjkvnBJeabS/view?usp=sharing . 
