import numpy as np
import pandas as pd

seeds = list(range(100))
n_cells = 4000
n_nodes = [7]
n_muts= [12]
n_CNVs= 3
dropout_sigma= 0.0
nodeprob_concentration= 10
regionprobs_sigma = 0.3
correlations = [0.0,0.5,1.0]
theta = 1000
depth=20

outdir = "out/"
tmpdir = "tmp/"

rule all:
    params:
        threads="1",
        runtime="10",
        memory="1000"
    input:
        "results_correlations.csv"

rule combine_results:
    params:
        threads="1",
        runtime="10",
        memory="1000"
    input:
        BD=expand(outdir+"syn_{nnodes}nodes_{nmuts}muts_{corr}corr_{seed}_MP3.txt", \
                nnodes=n_nodes,nmuts=n_muts,corr=correlations,seed=seeds)
    output:
        "results_correlations.csv"
    run:
        d={"nodes":[],"muts":[],"corr":[],"method":[],"MP3":[]}
        for infile in input.BD:
            with open(infile,"r") as f:
                result_COMPASS = float(f.readline())
            namesplit = infile.split("_")
            N_nodes=int(namesplit[1][:-5])
            N_muts=int(namesplit[2][:-4])
            corr=float(namesplit[3][:-4])
            d["nodes"].append(N_nodes)
            d["muts"].append(N_muts)
            d["corr"].append(corr)
            d["method"].append("COMPASS")
            d["MP3"].append(result_COMPASS)
        df = pd.DataFrame(d)
        df.to_csv("results_correlations.csv",index=False)

rule compute_MP3:
    params:
        threads="1",
        runtime="10",
        memory="1000"
    input:
        outdir+"{sample}_treeTRUE.gv",
        outdir+"{sample}_treeCOMPASS.gv"
    output:
        outdir+"{sample}_MP3.txt"
    shell:
        "python compute_MP3.py -i {outdir}{wildcards.sample} --tmp {tmpdir}{wildcards.sample} -o {output}"



rule generate_synthetic_data:
    params:
        threads="1",
        runtime="10",
        memory="1000"
    output:
        tmpdir+"syn_{nnodes}nodes_{nmuts}muts_{ncells}cells_{corr}corr_{seed}_variants.csv",
        tmpdir+"syn_{nnodes}nodes_{nmuts}muts_{ncells}cells_{corr}corr_{seed}_regions.csv",
        tmpdir+"syn_{nnodes}nodes_{nmuts}muts_{ncells}cells_{corr}corr_{seed}_tree.gv"
    shell:
        "python generate_synthetic_data_correlations.py -o {tmpdir}syn_{wildcards.nnodes}nodes_{wildcards.nmuts}muts_{wildcards.ncells}cells_{wildcards.corr}corr_{wildcards.seed} "\
        "--ncells {wildcards.ncells} --nnodes {wildcards.nnodes} --nSNVs {wildcards.nmuts} --nCNVs {n_CNVs} --corr {wildcards.corr} " \
        "--dropoutsigma {dropout_sigma} --nodeprobconcentration {nodeprob_concentration} --depth {depth} --theta {theta} --regionprobsigma {regionprobs_sigma} --seed {wildcards.seed}"

rule cp_true_tree:
    params:
        threads="1",
        runtime="10",
        memory="1000"
    input:
        tmpdir+"syn_{nnodes}nodes_{nmuts}muts_"+str(n_cells)+"cells_{corr}corr_{seed}_tree.gv"
    output:
        outdir+"syn_{nnodes}nodes_{nmuts}muts_{corr}corr_{seed}_treeTRUE.gv"
    shell: 
        "cp {input} {output}"

rule infer_tree_COMPASS:
    params:
        threads="4",
        runtime="1:50",
        memory="6000"
    input:
        tmpdir+"syn_{nnodes}nodes_{nmuts}muts_"+str(n_cells)+"cells_{corr}corr_{seed}_variants.csv",
        tmpdir+"syn_{nnodes}nodes_{nmuts}muts_"+str(n_cells)+"cells_{corr}corr_{seed}_regions.csv"
    output:
        outdir+"syn_{nnodes}nodes_{nmuts}muts_{corr}corr_{seed}_treeCOMPASS.gv"
    shell:
        "./COMPASS -o {output} -i {tmpdir}syn_{wildcards.nnodes}nodes_{wildcards.nmuts}muts_{n_cells}cells_{wildcards.corr}corr_{wildcards.seed} --nchains 4 --chainlength 10000 --burnin 2000 --temperature 10 -d 0 --filterregions 0"
